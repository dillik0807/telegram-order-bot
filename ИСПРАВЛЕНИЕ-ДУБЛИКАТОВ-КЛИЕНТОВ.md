# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏—Å—á–µ–∑–∞–ª, –∏ –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å –¥–æ–±–∞–≤–ª—è—Ç—å –≤—Å—ë –∑–∞–Ω–æ–≤–æ.

### –ü—Ä–∏—á–∏–Ω–∞

–§—É–Ω–∫—Ü–∏—è `approveClient` –≤ `database.js` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ `INSERT OR IGNORE`, —á—Ç–æ –æ–∑–Ω–∞—á–∞–ª–æ:
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–Ω **–Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ**
- –ù–æ —Ñ—É–Ω–∫—Ü–∏—è –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ `true` (—É—Å–ø–µ—Ö), –¥–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω
- –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –ø—É—Ç–∞–Ω–∏—Ü–µ –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `approveClient` –≤ `database.js`

**–ë—ã–ª–æ:**
```javascript
approveClient(telegramId, name, phone, approvedBy) {
  return new Promise((resolve, reject) => {
    this.db.serialize(() => {
      this.db.run(
        'INSERT OR IGNORE INTO clients (telegram_id, name, phone, added_by) VALUES (?, ?, ?, ?)',
        [telegramId, name, phone, approvedBy],
        (err) => {
          if (err) return reject(err);
          
          this.db.run(
            'UPDATE registration_requests SET status = "approved" WHERE telegram_id = ?',
            [telegramId],
            (err) => {
              if (err) return reject(err);
              resolve(true); // ‚ùå –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true
            }
          );
        }
      );
    });
  });
}
```

**–°—Ç–∞–ª–æ:**
```javascript
approveClient(telegramId, name, phone, approvedBy) {
  return new Promise((resolve, reject) => {
    this.db.serialize(() => {
      // ‚úÖ –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∫–ª–∏–µ–Ω—Ç
      this.db.get(
        'SELECT * FROM clients WHERE telegram_id = ?',
        [telegramId],
        (err, existingClient) => {
          if (err) return reject(err);
          
          if (existingClient) {
            // ‚úÖ –ö–ª–∏–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º false
            console.log(`‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç ${telegramId} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ`);
            this.db.run(
              'UPDATE registration_requests SET status = "approved" WHERE telegram_id = ?',
              [telegramId],
              (err) => {
                if (err) return reject(err);
                resolve(false); // ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º false
              }
            );
          } else {
            // ‚úÖ –ö–ª–∏–µ–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
            this.db.run(
              'INSERT INTO clients (telegram_id, name, phone, added_by) VALUES (?, ?, ?, ?)',
              [telegramId, name, phone, approvedBy],
              (err) => {
                if (err) return reject(err);
                
                console.log(`‚úÖ –ö–ª–∏–µ–Ω—Ç ${telegramId} (${name}) –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É`);
                
                this.db.run(
                  'UPDATE registration_requests SET status = "approved" WHERE telegram_id = ?',
                  [telegramId],
                  (err) => {
                    if (err) return reject(err);
                    resolve(true); // ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º true
                  }
                );
              }
            );
          }
        }
      );
    });
  });
}
```

### 2. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ–¥–æ–±—Ä–µ–Ω–∏—è –≤ `admin.js`

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞:**
```javascript
bot.action(/approve_(\d+)/, async (ctx) => {
  const userId = ctx.from.id;
  
  if (!isAdmin(userId)) {
    return ctx.answerCbQuery('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
  }
  
  const clientId = parseInt(ctx.match[1]);
  
  try {
    const request = await database.getRegistrationRequest(clientId);
    
    if (!request) {
      await ctx.answerCbQuery('‚ùå –ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return ctx.editMessageText('‚ùå –ó–∞–ø—Ä–æ—Å —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    
    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –∫–ª–∏–µ–Ω—Ç
    const existingClient = await database.getClient(clientId);
    if (existingClient) {
      await ctx.answerCbQuery('‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
      return ctx.editMessageText(
        `‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ!\n\n` +
        `üë§ –ò–º—è: ${existingClient.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n` +
        `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${existingClient.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}\n` +
        `üÜî ID: ${clientId}\n\n` +
        `–ó–∞–ø—Ä–æ—Å –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Ä–∞–Ω–µ–µ.`
      );
    }
    
    // –û–¥–æ–±—Ä—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞
    await database.approveClient(clientId, request.name, '', userId);
    
    console.log(`‚úÖ –ö–ª–∏–µ–Ω—Ç ${clientId} (${request.name}) –æ–¥–æ–±—Ä–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${userId}`);
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è:', error);
    await ctx.answerCbQuery('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏');
  }
});
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `/checkwarehouses`

–î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∫–ª–∞–¥–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞:

```javascript
bot.command('checkwarehouses', async (ctx) => {
  const userId = ctx.from.id;
  
  if (!isAdmin(userId)) {
    return ctx.reply('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
  }
  
  try {
    const warehouses = await database.getAllWarehouses();
    
    if (warehouses.length === 0) {
      return ctx.reply(
        'üìã –°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤ –ø—É—Å—Ç\n\n' +
        'üí° –î–æ–±–∞–≤—å—Ç–µ —Å–∫–ª–∞–¥ –∫–æ–º–∞–Ω–¥–æ–π:\n' +
        '/addwarehouse2 –ù–∞–∑–≤–∞–Ω–∏–µ_—Å–∫–ª–∞–¥–∞'
      );
    }
    
    let message = `üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ (${warehouses.length}):\n\n`;
    
    warehouses.forEach((w, index) => {
      const whatsappStatus = w.whatsapp_group_id ? 
        `‚úÖ WhatsApp: ${w.whatsapp_group_id}` : 
        '‚ùå WhatsApp –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
      
      message += `${index + 1}. ${w.name}\n`;
      message += `   üÜî ID: ${w.id}\n`;
      message += `   üì± ${whatsappStatus}\n`;
      message += `   üìÖ –°–æ–∑–¥–∞–Ω: ${new Date(w.created_at).toLocaleDateString('ru-RU')}\n\n`;
    });
    
    message += 'üí° –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:\n';
    message += '‚ûï –î–æ–±–∞–≤–∏—Ç—å: /addwarehouse2 –ù–∞–∑–≤–∞–Ω–∏–µ\n';
    message += 'üì± –ù–∞—Å—Ç—Ä–æ–∏—Ç—å WhatsApp: /setwhatsapp –ù–∞–∑–≤–∞–Ω–∏–µ | ID_–≥—Ä—É–ø–ø—ã\n';
    message += 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å: /removewarehouse ID';
    
    ctx.reply(message);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–∫–ª–∞–¥–æ–≤:', error);
    ctx.reply(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Å–∫–ª–∞–¥–æ–≤:\n\n${error.message}`);
  }
});
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test-client-duplicate-fix.js` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
node test-client-duplicate-fix.js
```

–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. ‚úÖ –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –∏—Å—á–µ–∑–∞–µ—Ç –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
2. ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≥–æ –∂–µ –∫–ª–∏–µ–Ω—Ç–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
3. ‚úÖ –§—É–Ω–∫—Ü–∏—è `approveClient` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
4. ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω—ã–º

## üìã –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏

- `/admin` - –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- `üìã –û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã` - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
- `/addclient ID | –ò–º—è | –¢–µ–ª–µ—Ñ–æ–Ω` - –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é
- `/removeclient ID` - –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
- `/editclient ID | –ò–º—è | –¢–µ–ª–µ—Ñ–æ–Ω` - –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
- `üìã –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤` - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞–º–∏

- `/checkwarehouses` - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Å–∫–ª–∞–¥—ã
- `/addwarehouse2 –ù–∞–∑–≤–∞–Ω–∏–µ` - –î–æ–±–∞–≤–∏—Ç—å —Å–∫–ª–∞–¥
- `/setwhatsapp –ù–∞–∑–≤–∞–Ω–∏–µ | ID_–≥—Ä—É–ø–ø—ã` - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å WhatsApp –≥—Ä—É–ø–ø—É
- `/removewarehouse ID` - –£–¥–∞–ª–∏—Ç—å —Å–∫–ª–∞–¥

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

- `/reloaddata` - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∫–ª–∞–¥–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ë–î

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. ‚úÖ –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ **–Ω–µ –∏—Å—á–µ–∑–∞–µ—Ç** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
2. ‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ **–±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. ‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç **–ø–æ–Ω—è—Ç–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
4. ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã **—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `/checkwarehouses` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∫–ª–∞–¥–æ–≤

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
2. –£–ª—É—á—à–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
4. –§—É–Ω–∫—Ü–∏—è `approveClient` —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã
- –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
- –õ–æ–≥–∏ –ø–æ–º–æ–≥–∞—é—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
